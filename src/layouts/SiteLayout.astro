---
import Header from "@components/Header.astro";
/* Consolidated global styles at layout level: load variables first for clarity and cascade */
import "@/styles/variables.css";
import "@/styles/layout/base.css";
import "@/styles/prose/typography.css";
import "@/styles/prose/media.css";
import "@/styles/prose/links.css";
import "@/styles/prose/code.css";
import "@/styles/utilities/accessibility.css";
import "@/styles/layout/site-layout.css";
import "@/styles/features/gallery.css";
import "@/styles/features/lightbox.css";
import "@/styles/features/stories.css";
import "@/styles/components/button.module.css";
import Sidebar from "@components/Sidebar/Sidebar.astro";
import SidebarController from "@components/SidebarController.astro";
import Footer from "@components/Footer/Footer.astro";
import SidebarToggleButton from "@components/SidebarToggleButton/SidebarToggleButton.astro";
import SidebarSocialFlyout from "@components/SidebarSocialFlyout/SidebarSocialFlyout.astro";
import ThemeToggle from "@components/ThemeToggle/ThemeToggle.astro";
import { GTM_ID } from "@lib/core/env";
import { isProductionSite } from "@lib/content/seo";

interface Props {
  title: string;
  selectedItem?: string;
  canonical?: string;
  prevHref?: string;
  nextHref?: string;
  jsonLd?: any;
  description?: string;
  image?: string;
  type?: 'website' | 'article' | 'profile';
  publishedTime?: Date | string;
  modifiedTime?: Date | string;
  tags?: string[];
  author?: string;
  showSidebar?: boolean;
  preloadSearch?: boolean;
}

/**
 * Helper signature: (sel: string) => boolean
 * Checks if a CSS selector matches any element in the document.
 */

const {
  title,
  selectedItem,
  canonical,
  prevHref,
  nextHref,
  jsonLd,
  description,
  image,
  type,
  publishedTime,
  modifiedTime,
  tags,
  author,
  showSidebar = true,
  preloadSearch = false
} = Astro.props as Props;
---

<!DOCTYPE html>
<html lang="id">
  <!-- HTML Head - Meta tags, SEO, analytics, fonts, and critical scripts -->
  <Header
    title={title}
    canonical={canonical}
    prevHref={prevHref}
    nextHref={nextHref}
    jsonLd={jsonLd}
    description={description}
    image={image}
    type={type}
    publishedTime={publishedTime}
    modifiedTime={modifiedTime}
    tags={tags}
    author={author}
    preloadSearch={preloadSearch}
  />
  <body>
    {/* Google Tag Manager NoScript Fallback - For users with JavaScript disabled (production only) */}
    {import.meta.env.PROD && isProductionSite() && GTM_ID && (
      <noscript><iframe src={`https://www.googletagmanager.com/ns.html?id=${GTM_ID}`} height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    )}
    
    <!-- Theme Toggle - Floating button (visible on body, separate from sidebar) -->
    <div class="theme-toggle-container theme-toggle-container--body">
      <ThemeToggle />
    </div>
    
    <!-- Main Content Container - Houses sidebar and page content -->
    <div class="content">
      {/* Conditional: Sidebar Components (hidden on pages with showSidebar=false) */}
      {showSidebar && <Sidebar selectedItem={selectedItem} />}
      {showSidebar && <SidebarController />}
      {showSidebar && <SidebarToggleButton />}
      {showSidebar && <SidebarSocialFlyout />}
      
      <!-- Main Navigation Container - Page content and footer -->
      <nav class="main">
        <!-- Content Container - Page-specific content injected via slot -->
        <div class="container">
          <slot />
        </div>
        
        <!-- Site Footer - Copyright and branding -->
        <Footer />
      </nav>
    </div>
    <script>
      // Global UI gate: import '../lib/ui-init' only when needed
      (() => {
        // Checks if a CSS selector matches any element in the document.
        function has(sel: string): boolean {
          return !!document.querySelector(sel);
        }
        const check = () => ({
          share: has('section.share') || has('.share__btn--copy') || has('.share__btn--native'),
          copy: has('pre code') || has('pre[class*="language-"]'),
          lightbox:
            has('.prose img:not(.hero-image)') ||
            has('.content-image-grid img:not(.hero-image)'),
          table: has('.prose table'),
          // Theme toggle is always present, so always true
          themeToggle: true,
        });

        const runImport = () => {
          import('@lib/infrastructure/ui-init')
            .then(m => m.initUi && m.initUi())
            .catch(e => console.error('ui-init import error:', e));
        };

        const s = check();
        // Always import because theme toggle is always present
        if (s.share || s.copy || s.lightbox || s.table || s.themeToggle) {
          runImport();
        } else {
          // This branch should never be reached now
          const reGate = () => {
            const q = check();
            if (q.share || q.copy || q.lightbox || q.table || q.themeToggle) {
              document.removeEventListener('astro:page-load', reGate);
              document.removeEventListener('astro:after-swap', reGate);
              import('@lib/infrastructure/ui-init')
                .then(m => m.initUi && m.initUi())
                .catch(e => console.error('ui-init import error:', e));
            }
          };
          document.addEventListener('astro:page-load', reGate);
          document.addEventListener('astro:after-swap', reGate);
          if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', reGate, { once: true });
          } else {
            setTimeout(reGate, 50);
          }
        }
      })();
    </script>
    <script>
      // Web Vitals Performance Monitoring
      // Runs unconditionally - module handles prod check internally
      import('@lib/tracking/web-vitals')
        .then(m => m.initWebVitals && m.initWebVitals())
        .catch(e => console.error('web-vitals init error:', e));
    </script>
    <script>
      // Service Worker Registration for offline support
      // Runs unconditionally - module handles prod check internally
      import('@lib/infrastructure/sw-register')
        .then(m => m.initServiceWorker && m.initServiceWorker())
        .catch(e => console.error('sw-register init error:', e));
    </script>
  </body>
  
</html>
