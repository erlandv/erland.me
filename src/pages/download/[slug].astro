---
import SiteLayout from '@layouts/SiteLayout.astro';
import BackNav from '@components/BackNav/BackNav.astro';
import { getCollection, getEntry } from 'astro:content';
import { creativeWorkJsonLd } from '@lib/content/seo';
import ShareButtons from '@components/ShareButtons/ShareButtons.astro';
import StarRating from '@components/StarRating/StarRating.astro';
import { SITE_CONFIG } from '@lib/core/site-config';
import '@/styles/components/hero.css';
import '@/styles/components/article-detail.css';
import '@/styles/components/toc.css';
import '@/styles/prose/tables.css';
import '@/styles/prose/ads.css';
import ScrollTopButton from '@components/ScrollTopButton/ScrollTopButton.astro';
import ContentImage from '@components/ContentImage.astro';
import HeroImage from '@components/HeroImage.astro';
import { getOgImageUrl, resolveHero } from '@lib/content/images';
import { SITE_URL } from '@lib/core/env';

export async function getStaticPaths() {
  const downloads = await getCollection('downloads');
  return downloads
    .filter((item: any) => !item.data.draft)
    .map((item: any) => ({ params: { slug: item.slug } }));
}

const { slug } = Astro.params;
const entry = await getEntry('downloads', slug ?? '');

if (!entry || entry.data.draft) {
  return Astro.redirect('/download/');
}

const { Content } = await entry.render();
const data = entry.data;

const hero = resolveHero(data.hero);
const heroAlt = data.heroAlt ?? data.title;
const optimizedHero = hero
  ? await getOgImageUrl(hero, 1200, 'avif')
  : undefined;
const canonicalPath = `/download/${entry.slug}/`;
const canonicalUrl = `${SITE_URL}${canonicalPath}`;

const jsonLd = creativeWorkJsonLd({
  title: data.title,
  description: data.description ?? data.excerpt,
  publishDate: data.publishDate,
  lastUpdated: data.updatedDate,
  url: canonicalPath,
  image: optimizedHero ?? undefined,
  rating: data.rating ?? undefined,
});
---

<SiteLayout
  title={data.title}
  description={data.description || data.excerpt}
  canonical={canonicalPath}
  jsonLd={jsonLd}
  selectedItem='download'
  image={optimizedHero}
  author={SITE_CONFIG.author.name}
  type="article"
  publishedTime={data.publishDate}
  modifiedTime={data.updatedDate ?? data.publishDate}
>
  <!-- Back Navigation - Return to download listing page -->
  <BackNav href='/download/' />
  
  <!-- Download Article - Template/file details with download information -->
  <article class:list={['content-container', 'article-detail']}>
    <!-- Article Header - Hero image (or placeholder emoji), title, and optional rating -->
    <header class='article-header'>
      {/* Conditional: Hero image or fallback placeholder with package emoji */}
      {
        hero ? (
          <HeroImage image={hero} alt={heroAlt} loading='eager' fetchpriority='high' />
        ) : (
          <div class='hero-image hero-placeholder' aria-hidden='true'>
            ðŸ“¦
          </div>
        )
      }
      
      <!-- Article Title -->
      <h1>{data.heading ?? data.title}</h1>
      
      {/* Conditional: Star rating display (if rating data provided) */}
      {data.rating && (
        <StarRating
          ratingValue={data.rating.ratingValue}
          reviewCount={data.rating.reviewCount}
          bestRating={data.rating.bestRating}
        />
      )}
    </header>

    <!-- Article Content - Markdown rendered with download files table and custom images -->
    <div class='prose' id='download-content'>
      <Content components={{ img: ContentImage }} />
    </div>

    <!-- Social Share Buttons - Share template to social platforms -->
    <ShareButtons
      title={data.title}
      url={canonicalUrl}
      description={data.description ?? data.excerpt}
      heading='Share this template:'
    />
  </article>
  
  <!-- Scroll to Top Button - Floating button for long content -->
  <ScrollTopButton />
</SiteLayout>

<script>
  import {
    autoInitDownloadAds,
    autoInitDownloadPlaceholders,
    shouldRenderAds,
    shouldRenderPlaceholders,
  } from '@lib/tracking/ads';
  import { autoInit as autoInitToc } from '@lib/features/toc';

  // Initialize dynamic TOC after content renders
  const runToc = () => {
    try {
      autoInitToc();
    } catch {}
  };

  const runAds = () => {
    try {
      const client = import.meta.env.PUBLIC_ADSENSE_CLIENT || '';
      const slotStart = import.meta.env.PUBLIC_ADSENSE_SLOT_START || '';
      const slotEnd = import.meta.env.PUBLIC_ADSENSE_SLOT_END || '';
      
      if (
        shouldRenderAds({
          client,
          slots: [slotStart, slotEnd],
        })
      ) {
        autoInitDownloadAds(client, slotStart, slotEnd);
      } else if (shouldRenderPlaceholders()) {
        autoInitDownloadPlaceholders();
      }
    } catch {}
  };

  runToc();
  runAds();

  const rebroadcast = () => {
    runToc();
    runAds();
  };

  document.addEventListener('astro:page-load', rebroadcast);
  document.addEventListener('astro:after-swap', rebroadcast);
</script>
