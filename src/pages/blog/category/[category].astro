---
import SiteLayout from '@layouts/SiteLayout.astro';
import Breadcrumb from '@components/Breadcrumb/Breadcrumb.astro';
import { createBlogCategoryBreadcrumb } from '@lib/content/breadcrumb';
import PostCard from '@components/PostCard/PostCard.astro';
import Pagination from '@components/Pagination/Pagination.astro';
import SearchInput from '@components/SearchInput/SearchInput.astro';
import ScrollTopButton from '@components/ScrollTopButton/ScrollTopButton.astro';
import { loadAllPosts, slicePage, slugifyCategory } from '@lib/content/blog';
import { collectionPageJsonLd, breadcrumbJsonLd } from '@lib/content/seo';
import { SITE_CONFIG } from '@lib/core/site-config';
import { generateCategoryPageMeta } from '@lib/content/page-metadata';
import listing from '@/styles/pages/listing.module.css';

// Build-time static paths for each category found in content
export async function getStaticPaths() {
  const posts = await loadAllPosts();
  const categories = Array.from(
    new Set(
      posts
        .map(p => (p.data?.category ?? '').toString().trim())
        .filter(Boolean),
    ),
  );
  return categories.map(c => ({ params: { category: slugifyCategory(c) } }));
}

const allPosts = await loadAllPosts();
const categoryParam = (Astro.params.category ?? '').toString().toLowerCase();

// Filter posts by category (case-insensitive compare)
const filtered = allPosts.filter(p => {
  const cat = slugifyCategory((p.data?.category ?? '').toString());
  return cat === categoryParam;
});

const pageSize = 10;
const page = 1;
const totalPages = Math.max(1, Math.ceil(filtered.length / pageSize));
const paginated = slicePage(filtered, page, pageSize);
const pageHref = (n: number) =>
  n === 1
    ? `/blog/category/${categoryParam}/`
    : `/blog/category/${categoryParam}/page/${n}/`;

// Capitalize first letter of category for display
const capitalize = (str: string) =>
  str.charAt(0).toUpperCase() + str.slice(1).toLowerCase();
const displayCategory = capitalize(categoryParam);

const getHero = (post: any) => post.data?.hero ?? null;
const getExcerpt = (post: any) =>
  post.data?.excerpt ?? post.data?.description ?? '';
const getCategory = (post: any) => post.data?.category ?? null;

const { title, description } = generateCategoryPageMeta(displayCategory);
---

<SiteLayout
  title={`${title} by ${SITE_CONFIG.author.name}`}
  canonical={`/blog/category/${categoryParam}/`}
  description={description}
  nextHref={totalPages > 1 ? pageHref(2) : undefined}
  jsonLd={[
    collectionPageJsonLd(
      `Blog Category: ${categoryParam}`,
      `/blog/category/${categoryParam}/`,
      paginated.map((p, i) => ({
        url: `/blog/${p.slug}/`,
        name: p.data.title,
        position: i + 1,
      })),
    ),
    breadcrumbJsonLd([
      { name: 'Blog', url: '/blog/' },
      { name: 'Categories', url: '/blog/category/' },
      { name: categoryParam, url: `/blog/category/${categoryParam}/` },
    ]),
  ]}
  selectedItem='blog'
  preloadSearch
>
  <!-- Breadcrumb Navigation - Shows hierarchical path: Home > Blog > Categories > Category -->
  <Breadcrumb
    items={createBlogCategoryBreadcrumb(displayCategory, categoryParam)}
  />

  <div class='content-container'>
    <h1 style='text-transform: capitalize;'>Category {displayCategory}</h1>

    <SearchInput placeholder={`Cari artikel...`} />

    <section class={listing['items-container']}>
      <div class={listing['resouce-items']}>
        {
          paginated.map(post => {
            const hero = getHero(post);
            const excerpt = getExcerpt(post);
            const dateLabel = post.date
              ? post.date.toLocaleDateString('id-ID', { dateStyle: 'medium' })
              : null;
            return (
              <PostCard
                href={`/blog/${post.slug}/`}
                title={post.data.title}
                hero={hero}
                alt={post.data.heroAlt ?? post.data.title}
                category={getCategory(post)}
                dateLabel={dateLabel}
                excerpt={excerpt}
              />
            );
          })
        }

        {
          filtered.length === 0 && (
            <p style='opacity:.8;'>Tidak ada artikel dalam kategori ini.</p>
          )
        }
      </div>
    </section>
    {
      filtered.length > pageSize && (
        <Pagination page={page} totalPages={totalPages} pageHref={pageHref} />
      )
    }
  </div>

  <ScrollTopButton />
</SiteLayout>
