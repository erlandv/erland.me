---
import SiteLayout from '../../../../../layouts/SiteLayout.astro';
import BackNav from "../../../../../components/BackNav.astro";
import PostCard from "../../../../../components/PostCard.astro";
import Pagination from "../../../../../components/Pagination.astro";
import SearchInput from "../../../../../components/SearchInput.astro";
import { postToSearchable } from '../../../../../lib/search';
import { loadAllPosts } from '../../../../../lib/blog';
import { collectionPageJsonLd } from '../../../../../lib/seo';
import listing from "../../../../../styles/pages/listing.module.css";

// Generate static paths for pages in each category
export async function getStaticPaths() {
  const posts = await loadAllPosts();
  const categoryBuckets = new Map<string, number>();

  for (const p of posts) {
    const cat = (p.data?.category ?? '').toString().toLowerCase().trim();
    if (!cat) continue;
    categoryBuckets.set(cat, (categoryBuckets.get(cat) ?? 0) + 1);
  }

  const pageSize = 10;
  const paths: { params: { category: string; page: string } }[] = [];
  for (const [cat, count] of categoryBuckets) {
    const totalPages = Math.max(1, Math.ceil(count / pageSize));
    // Only page 2..N here (page 1 handled by /blog/category/[category])
    for (let i = 2; i <= totalPages; i++) {
      paths.push({ params: { category: cat, page: String(i) } });
    }
  }
  return paths;
}

const allPosts = await loadAllPosts();
const categoryParam = (Astro.params.category ?? '').toString().toLowerCase();

// Filter posts by category (case-insensitive compare)
const filtered = allPosts.filter((p: any) => {
  const cat = (p.data?.category ?? '').toString().toLowerCase();
  return cat === categoryParam;
});

// Pagination
const pageSize = 10;
const totalPages = Math.max(1, Math.ceil(filtered.length / pageSize));
const param = Number(Astro.params.page ?? '1');
const page = !Number.isFinite(param) || param < 1 ? 1 : Math.min(totalPages, Math.floor(param));
const paginated = filtered.slice((page - 1) * pageSize, page * pageSize);
const pageHref = (n: number) => (n === 1 ? `/blog/category/${categoryParam}/` : `/blog/category/${categoryParam}/page/${n}/`);

const normalizeHero = (hero: any) => {
  if (!hero) return null;
  if (typeof hero === 'string') {
    return { src: hero, width: 512, height: 512 };
  }
  const { src, width, height } = hero;
  return { src, width, height };
};

const getHero = (post: any) => normalizeHero(post.data?.hero ?? post.hero);
const getExcerpt = (post: any) => post.data?.excerpt ?? post.data?.description ?? '';
const getCategory = (post: any) => post.data?.category ?? null;

// Convert posts to searchable format (used by SearchInput via window.__SEARCH_POSTS__)
const searchablePosts = filtered.map(postToSearchable);
---

<SiteLayout
  title={`Blog Archives in "${categoryParam}" - Page ${page}`}
  canonical={pageHref(page)}
  description={`Halaman ${page} dari arsip kategori \"${categoryParam}\".`}
  prevHref={page > 1 ? pageHref(page - 1) : undefined}
  nextHref={page < totalPages ? pageHref(page + 1) : undefined}
  jsonLd={collectionPageJsonLd(
    `Blog Category: ${categoryParam} - Page ${page}`,
    pageHref(page),
    paginated.map((p: any, i: number) => ({
      url: `/blog/${p.slug}/`,
      name: p.data.title,
      position: (page - 1) * pageSize + i + 1,
    }))
  )}
  selectedItem="blog"
>
  <BackNav href="/" label="Back" />

  <div class="content-container">
    <h1>Blog Posts</h1>
    
    <!-- Search Component -->
    <SearchInput posts={searchablePosts} placeholder={`Cari artikel di kategori \"${categoryParam}\"...`} />
    <section class={listing['items-container']}>
      <div class={listing['resouce-items']}>
        {paginated.map((post: any) => {
          const hero = getHero(post);
          const excerpt = getExcerpt(post);
          const dateLabel = post.date
            ? post.date.toLocaleDateString('id-ID', { dateStyle: 'medium' })
            : null;
          return (
            <PostCard
              href={`/blog/${post.slug}/`}
              title={post.data.title}
              hero={hero}
              alt={post.data.heroAlt ?? post.data.title}
              category={getCategory(post)}
              dateLabel={dateLabel}
              excerpt={excerpt}
            />
          );
        })}

        {filtered.length === 0 && (
          <p style="opacity:.8;">Belum ada tulisan untuk kategori ini.</p>
        )}

        {filtered.length > pageSize && (
          <Pagination page={page} totalPages={totalPages} pageHref={pageHref} />
        )}
      </div>
    </section>
  </div>
</SiteLayout>

<script define:vars={{ searchablePosts }} is:inline>
  // Make searchable posts available to the search component
  function initSearchData() {
    try {
      window.__SEARCH_POSTS__ = searchablePosts;
    } catch (error) {
      console.error('Failed to initialize search posts data:', error);
    }
  }

  // Setup router reinit for ClientRouter compatibility
  let routerSetup = false;
  function setupRouterReinit() {
    if (routerSetup) return;
    routerSetup = true;

    const run = () => {
      if (window.location.pathname.startsWith('/blog/category')) {
        initSearchData();
      }
    };

    document.addEventListener('astro:page-load', run);
    document.addEventListener('astro:after-swap', run);
    window.addEventListener('popstate', run);
    const _push = history.pushState && history.pushState.bind(history);
    if (_push) {
      history.pushState = function (data, unused, url) {
        const ret = _push(data, unused, url);
        setTimeout(run, 10);
        return ret;
      };
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      initSearchData();
      setupRouterReinit();
    });
  } else {
    initSearchData();
    setupRouterReinit();
  }
</script>
