---
import SiteLayout from '@layouts/SiteLayout.astro';
import BackNav from '@components/BackNav/BackNav.astro';
import PostCard from '@components/PostCard/PostCard.astro';
import Pagination from '@components/Pagination/Pagination.astro';
import listing from '@/styles/pages/listing.module.css';
import catStyles from '@/pages/blog/styles/_category.module.css';
import { loadAllPosts, slugifyCategory, slicePage } from '@lib/blog';
import { categoriesIndexJsonLd, breadcrumbJsonLd } from '@lib/seo';
import type { ImageMetadata } from 'astro';

const posts = await loadAllPosts();

type CatInfo = {
  name: string;
  slug: string;
  count: number;
  latest: {
    slug: string;
    title: string;
    excerpt: string | null;
    date: Date | null;
  } | null;
  hero: ImageMetadata | null;
};

const getExcerpt = (post: any) =>
  post.data?.excerpt ?? post.data?.description ?? '';

const categoriesMap = new Map<string, CatInfo>();
for (const p of posts) {
  const raw = (p.data?.category ?? '').toString();
  if (!raw) continue;
  const slug = slugifyCategory(raw);
  if (!slug) continue;
  const existing = categoriesMap.get(slug);
  if (!existing) {
    categoriesMap.set(slug, {
      name: raw,
      slug,
      count: 1,
      latest: p
        ? {
            slug: p.slug,
            title: p.data?.title,
            excerpt: getExcerpt(p),
            date: p.date ?? null,
          }
        : null,
      hero: p.data?.hero ?? null,
    });
  } else {
    existing.count += 1;
    // posts is sorted desc by date; ensure latest is the most recent
    const pDate = p.date?.valueOf() ?? 0;
    const eDate = existing.latest?.date?.valueOf() ?? -1;
    if (pDate > eDate) {
      existing.latest = {
        slug: p.slug,
        title: p.data?.title,
        excerpt: getExcerpt(p),
        date: p.date ?? null,
      };
      existing.hero = p.data?.hero ?? null;
    }
  }
}

const categories = Array.from(categoriesMap.values()).sort((a, b) =>
  a.name.localeCompare(b.name, 'id')
);

// Build paginated posts for each category to mirror /blog/
const pageSize = 10;
const byCategory = categories.map(cat => {
  const catPosts = posts.filter(
    p => slugifyCategory(String(p.data?.category || '')) === cat.slug
  );
  const totalPages = Math.max(1, Math.ceil(catPosts.length / pageSize));
  const pages = Array.from({ length: totalPages }, (_, i) =>
    slicePage(catPosts, i + 1, pageSize)
  );
  return { cat, pages, totalPages };
});
---

<SiteLayout
  title='All Blog Categories by Erland Ramdhani'
  canonical='/blog/category/'
  description='Daftar kategori blog posts by Erland Ramdhani. Cek berbagai topik menarik yang telah dibahas di blog ini.'
  selectedItem='blog'
  jsonLd={[
    categoriesIndexJsonLd(
      'Blog Categories',
      '/blog/category/',
      categories.map((c, i) => ({
        url: `/blog/category/${c.slug}/`,
        name: c.name,
        position: i + 1,
      }))
    ),
    breadcrumbJsonLd([
      { name: 'Blog', url: '/blog/' },
      { name: 'Categories', url: '/blog/category/' },
    ]),
  ]}
>
  <BackNav href='/blog/' label='Back to Blog' />

  <div class='content-container'>
    <h1>Blog Categories</h1>

    <div id='category-filter' class={catStyles.filterContainer}>
      {
        categories.map(c => (
          <a
            href={`#cat-${c.slug}-page-1`}
            class:list={['cat-filter-btn', 'btn']}
            data-cat={c.slug}
          >
            {c.name}
          </a>
        ))
      }
    </div>

    <section class={listing['items-container']}>
      {
        byCategory.map(({ cat, pages, totalPages }) =>
          pages.map((pagePosts, idx) => {
            const page = idx + 1;
            const pageHref = (n: number) => `#cat-${cat.slug}-page-${n}`;
            return (
              <div
                class={listing['resouce-items']}
                data-cat-page
                data-cat={cat.slug}
                data-page={String(page)}
                style='display:none;'
              >
                {pagePosts.map(post => {
                  const hero = post.data?.hero ?? null;
                  const excerpt = getExcerpt(post);
                  const dateLabel = post.date
                    ? post.date.toLocaleDateString('id-ID', {
                        dateStyle: 'medium',
                      })
                    : null;
                  return (
                    <PostCard
                      href={`/blog/${post.slug}/`}
                      title={post.data.title}
                      hero={hero}
                      alt={post.data.heroAlt ?? post.data.title}
                      category={post.data?.category ?? null}
                      dateLabel={dateLabel}
                      excerpt={excerpt}
                    />
                  );
                })}
                {pagePosts.length === 0 && (
                  <p style='opacity:.8;'>Tidak ada artikel.</p>
                )}
                {totalPages > 1 && (
                  <Pagination
                    page={page}
                    totalPages={totalPages}
                    pageHref={pageHref}
                  />
                )}
              </div>
            );
          })
        )
      }
      {
        categories.length === 0 && (
          <p style='opacity:.8;'>Tidak ada kategori yang tersedia.</p>
        )
      }
    </section>
  </div>
</SiteLayout>

<script is:inline>
  (function () {
    // Parse hash to get category and page number
    function parseHash() {
      const match = (location.hash || '').match(
        /^#cat-([^#]+?)(?:-page-(\d+))?$/
      );
      return match
        ? {
            cat: match[1],
            page: Math.max(1, parseInt(match[2] || '1', 10) || 1),
          }
        : null;
    }

    // Show specific category page and update active filter button
    function showCategoryPage(category, page) {
      // Hide all category pages
      document.querySelectorAll('[data-cat-page]').forEach(function (el) {
        if (el instanceof HTMLElement) {
          el.style.display = 'none';
        }
      });

      // Show target page
      const target = document.querySelector(
        `[data-cat-page][data-cat="${category}"][data-page="${page}"]`
      );
      if (target instanceof HTMLElement) {
        target.style.display = '';
      }

      // Update active filter button
      document
        .querySelectorAll('#category-filter .cat-filter-btn')
        .forEach(function (btn) {
          if (btn instanceof HTMLElement) {
            const btnCat = btn.getAttribute('data-cat');
            if (btnCat === category) {
              btn.classList.add('is-active');
            } else {
              btn.classList.remove('is-active');
            }
          }
        });
    }

    // Initialize page on load
    function init() {
      let parsed = parseHash();

      // If no hash, pick random category
      if (!parsed) {
        const allCats = Array.from(
          new Set(
            Array.from(document.querySelectorAll('[data-cat-page]'))
              .map(function (el) {
                return el.getAttribute('data-cat');
              })
              .filter(Boolean)
          )
        );
        if (allCats.length > 0) {
          const randomCat = allCats[Math.floor(Math.random() * allCats.length)];
          location.replace(`#cat-${randomCat}-page-1`);
          parsed = { cat: randomCat, page: 1 };
        }
      }

      if (parsed) {
        showCategoryPage(parsed.cat, parsed.page);
      }

      // Attach click handlers to filter buttons
      document
        .querySelectorAll('#category-filter .cat-filter-btn')
        .forEach(function (btn) {
          btn.addEventListener('click', function (e) {
            e.preventDefault();
            const cat = btn.getAttribute('data-cat');
            if (cat) {
              const hash = `#cat-${cat}-page-1`;
              if (location.hash !== hash) {
                location.hash = hash;
              }
              showCategoryPage(cat, 1);
            }
          });
        });
    }

    // Handle hash changes
    window.addEventListener('hashchange', function () {
      const parsed = parseHash();
      if (parsed) {
        showCategoryPage(parsed.cat, parsed.page);
      }
    });

    // Handle pagination link clicks
    document.addEventListener('click', function (e) {
      const target = e.target;
      if (target) {
        let link = null;
        if (target instanceof HTMLAnchorElement) {
          link = target;
        } else if (
          target instanceof Element &&
          typeof target.closest === 'function'
        ) {
          link = target.closest('a');
        }

        if (link) {
          const href = link.getAttribute('href') || '';
          if (href.startsWith('#cat-')) {
            const match = href.match(/^#cat-([^#]+?)(?:-page-(\d+))?$/);
            if (match) {
              e.preventDefault();
              const cat = match[1];
              const page = Math.max(1, parseInt(match[2] || '1', 10) || 1);
              if (location.hash !== href) {
                location.hash = href;
              }
              showCategoryPage(cat, page);
            }
          }
        }
      }
    });

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }

    // Re-initialize on Astro view transitions
    document.addEventListener('astro:page-load', init);
    document.addEventListener('astro:after-swap', init);
  })();
</script>
