---
import SiteLayout from '@layouts/SiteLayout.astro';
import Breadcrumb from '@components/Breadcrumb/Breadcrumb.astro';
import { createBlogCategoryIndexBreadcrumb } from '@lib/content/breadcrumb';
import Icon from '@components/Icon.astro';
import SearchInput from '@components/SearchInput/SearchInput.astro';
import { SITE_CONFIG } from '@lib/core/site-config';
import { PAGE_METADATA } from '@lib/content/page-metadata';
import listing from '@/styles/pages/listing.module.css';
import categoryIndex from '@/pages/blog/styles/_category-index.module.css';
import { loadAllPosts, slugifyCategory } from '@lib/content/blog';
import { categoriesIndexJsonLd, breadcrumbJsonLd } from '@lib/content/seo';
import type { ImageMetadata } from 'astro';

const posts = await loadAllPosts();

type CatInfo = {
  name: string;
  slug: string;
  count: number;
  latest: {
    slug: string;
    title: string;
    excerpt: string | null;
    date: Date | null;
  } | null;
  hero: ImageMetadata | null;
};

const getExcerpt = (post: any) =>
  post.data?.excerpt ?? post.data?.description ?? '';

const categoriesMap = new Map<string, CatInfo>();
for (const p of posts) {
  const raw = (p.data?.category ?? '').toString();
  if (!raw) continue;
  const slug = slugifyCategory(raw);
  if (!slug) continue;
  const existing = categoriesMap.get(slug);
  if (!existing) {
    categoriesMap.set(slug, {
      name: raw,
      slug,
      count: 1,
      latest: p
        ? {
            slug: p.slug,
            title: p.data?.title,
            excerpt: getExcerpt(p),
            date: p.date ?? null,
          }
        : null,
      hero: p.data?.hero ?? null,
    });
  } else {
    existing.count += 1;
    // posts is sorted desc by date; ensure latest is the most recent
    const pDate = p.date?.valueOf() ?? 0;
    const eDate = existing.latest?.date?.valueOf() ?? -1;
    if (pDate > eDate) {
      existing.latest = {
        slug: p.slug,
        title: p.data?.title,
        excerpt: getExcerpt(p),
        date: p.date ?? null,
      };
      existing.hero = p.data?.hero ?? null;
    }
  }
}

const categories = Array.from(categoriesMap.values()).sort(
  (a, b) => b.count - a.count, // Sort by post count (most popular first)
);
---

<SiteLayout
  title={`${PAGE_METADATA.blog.categoryIndex.title} by ${SITE_CONFIG.author.name}`}
  canonical='/blog/category/'
  description={PAGE_METADATA.blog.categoryIndex.description}
  selectedItem='blog'
  preloadSearch
  jsonLd={[
    categoriesIndexJsonLd(
      'Blog Categories',
      '/blog/category/',
      categories.map((c, i) => ({
        url: `/blog/category/${c.slug}/`,
        name: c.name,
        position: i + 1,
      })),
    ),
    breadcrumbJsonLd([
      { name: 'Blog', url: '/blog/' },
      { name: 'Categories', url: '/blog/category/' },
    ]),
  ]}
>
  <!-- Breadcrumb Navigation - Shows hierarchical path: Home > Blog > Categories -->
  <Breadcrumb items={createBlogCategoryIndexBreadcrumb()} />

  <div class='content-container'>
    <h1>Browse by Category</h1>

    <SearchInput placeholder='Cari artikel...' />

    <section class={listing['items-container']}>
      <div class={categoryIndex['category-grid']}>
        {
          categories.map(c => (
            <a
              href={`/blog/category/${c.slug}/`}
              class={categoryIndex['category-card']}
            >
              <div class={categoryIndex['category-card__inner']}>
                {c.hero ? (
                  <div class={categoryIndex['category-card__thumb']}>
                    <img
                      src={c.hero.src}
                      alt={c.name}
                      class={categoryIndex['category-card__img']}
                      loading='lazy'
                    />
                  </div>
                ) : (
                  <div class={categoryIndex['category-card__thumb']}>
                    <div
                      class={categoryIndex['category-card__thumb--placeholder']}
                    />
                  </div>
                )}

                <div class={categoryIndex['category-card__body']}>
                  <div class={categoryIndex['category-card__header']}>
                    <h2 class={categoryIndex['category-card__title']}>
                      {c.name}
                    </h2>
                    <p class={categoryIndex['category-card__count']}>
                      {c.count} {c.count === 1 ? 'artikel' : 'artikel'}
                    </p>
                  </div>

                  {c.latest && (
                    <div class={categoryIndex['category-card__latest']}>
                      <span
                        class={categoryIndex['category-card__latest-label']}
                      >
                        Latest Post:
                      </span>
                      <p class={categoryIndex['category-card__latest-title']}>
                        {c.latest.title}
                      </p>
                      {c.latest.date && (
                        <p class={categoryIndex['category-card__latest-date']}>
                          {c.latest.date.toLocaleDateString('id-ID', {
                            dateStyle: 'medium',
                          })}
                        </p>
                      )}
                    </div>
                  )}

                  <div class={categoryIndex['category-card__footer']}>
                    <span class={categoryIndex['category-card__link']}>
                      View all posts
                      <Icon
                        name='blogReadmore'
                        class={categoryIndex['category-card__link-icon']}
                      />
                    </span>
                  </div>
                </div>
              </div>
            </a>
          ))
        }
      </div>

      {
        categories.length === 0 && (
          <p style='opacity:.8;'>Tidak ada kategori yang tersedia.</p>
        )
      }
    </section>
  </div>
</SiteLayout>
