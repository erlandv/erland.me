---
import Header from '../../components/Header.astro';
import Sidebar from '../../components/Sidebar.astro';

// Ambil semua post dari src/posts/blog/**/index.md (tanpa koleksi content)
const modules = import.meta.glob('../../posts/blog/*/index.md', { eager: true });
// Ambil hero image per post (jika ada)
const heroMap = import.meta.glob('../../posts/blog/*/hero.{jpg,jpeg,png,webp,gif,svg}', {
  as: 'url',
  eager: true,
});

type PostModule = { frontmatter: any } & { default: any };

// Helper untuk parsing tanggal yang aman
const safeDate = (value: unknown): Date | null => {
  if (!value) return null;
  const d = new Date(value as any);
  return isNaN(d.valueOf()) ? null : d;
};

const posts = Object.entries(modules)
  .map(([path, mod]) => {
    const m = mod as PostModule;
    const parts = path.split('/');
    const slug = parts[parts.length - 2]; // nama folder post
    const hero = Object.entries(heroMap).find(([p]) => p.startsWith(`../../posts/blog/${slug}/hero.`))?.[1] as
      | string
      | undefined;
    const date = safeDate(m.frontmatter?.publishDate);
    return {
      slug,
      data: m.frontmatter ?? {},
      date,
      hero,
      Content: m.default,
    };
  })
  .filter((p) => !p.data?.draft)
  // Urutkan dengan aman; jika tidak ada tanggal, jadikan paling lama
  .sort((a, b) => (b.date?.valueOf() ?? 0) - (a.date?.valueOf() ?? 0));
---

<!DOCTYPE html>
<html>
  <Header title="Blog | Erland" />
  <body>
    <div class="content">
      <Sidebar selectedItem="blog" />
      <nav class="main">
        <div class="container">
          <div class="back-nav-container">
            <a href="/" class="back-nav-button w-inline-block">
              <img src="/assets/back.svg" loading="lazy" alt="" class="back-nav-img" />
              <div>Back</div>
            </a>
          </div>

          <div class="content-container">
            <h1>Blog</h1>
            <section class="items-container">
              <div class="resouce-items">
                {posts.map((post) => (
                  <a href={`/blog/${post.slug}/`} class="w-inline-block" style="text-decoration:none;">
                    <article
                      class="resource-card"
                      style="
                        border: 1px solid var(--border, rgba(0,0,0,.08));
                        border-radius: 12px;
                        padding: 16px 18px;
                        transition: transform .12s ease, box-shadow .12s ease;
                      "
                    >
                      {post.hero && (
                        <img
                          src={post.hero}
                          alt={post.data.heroAlt ?? post.data.title}
                          loading="lazy"
                          style="display:block; width:100%; height:140px; object-fit:cover; border-radius:8px; margin:0 0 .75rem 0;"
                        />
                      )}
                      <header style="display:flex; gap:.5rem; align-items:baseline; flex-wrap:wrap;">
                        <h2 style="margin:0; font-size:1.125rem; font-weight:700;">
                          {post.data.title}
                        </h2>
                        {post.date && (
                          <time
                            datetime={post.date.toISOString()}
                            style="opacity:.7; font-size:.9rem;"
                          >
                            {post.date.toLocaleDateString('id-ID', { dateStyle: 'medium' })}
                          </time>
                        )}
                      </header>

                      {post.data.description && (
                        <p style="margin:.5rem 0 0; opacity:.9;">
                          {post.data.description}
                        </p>
                      )}

                      {post.data.tags?.length > 0 && (
                        <ul style="display:flex; gap:.5rem; margin:.75rem 0 0; padding:0; list-style:none;">
                          {post.data.tags.map((t) => (
                            <li
                              style="
                                padding:.2rem .6rem;
                                border:1px solid var(--border, rgba(0,0,0,.08));
                                border-radius:999px;
                                font-size:.8rem;
                                opacity:.9;
                              "
                            >
                              {t}
                            </li>
                          ))}
                        </ul>
                      )}
                    </article>
                  </a>
                ))}
                
                {posts.length === 0 && (
                  <p style="opacity:.8;">Belum ada tulisan. Tambahkan folder di <code>src/posts/blog/[slug]/index.md</code> ya ✍️</p>
                )}
              </div>
            </section>
          </div>
        </div>
      </nav>
    </div>

    <style>
      .resource-card:hover {
        transform: translateY(-2px);
      }
    </style>

    <!--[if lte IE 9]><script src="//cdnjs.cloudflare.com/ajax/libs/placeholders/3.0.2/placeholders.min.js"></script><![endif]-->
  </body>
</html>
