---
import Header from '../../components/Header.astro';
import Sidebar from '../../components/Sidebar.astro';
import Icon from "../../components/Icon.astro";
import Footer from "../../components/Footer.astro";
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  return posts.map((p) => ({ params: { slug: p.slug } }));
}

const { slug } = Astro.params;
const entry = (await getCollection('blog')).find((e) => e.slug === slug);
if (!entry) {
  return Astro.redirect('/blog');
}

const { Content } = await entry.render();
const frontmatter = entry.data;

// Auto-detect hero image placed as: src/content/blog/[slug]/hero.(jpg|jpeg|png,webp,gif,svg)
const heroMap = import.meta.glob('../../content/blog/*/hero.{jpg,jpeg,png,webp,gif,svg}', {
  as: 'url',
  eager: true,
});
const hero = Object.entries(heroMap).find(([p]) => p.startsWith(`../../content/blog/${slug}/hero.`))?.[1] as
  | string
  | undefined;
const heroAlt = frontmatter.heroAlt ?? frontmatter.title;
const canonical = `/blog/${slug}/`;

const jsonLd = {
  '@context': 'https://schema.org',
  '@type': 'BlogPosting',
  headline: frontmatter.title,
  datePublished: frontmatter.publishDate ? new Date(frontmatter.publishDate).toISOString() : undefined,
  dateModified: (frontmatter.updatedDate ? new Date(frontmatter.updatedDate) : new Date(frontmatter.publishDate || Date.now())).toISOString(),
  mainEntityOfPage: canonical,
  image: hero ? [hero] : undefined,
};
---

<!DOCTYPE html>
<html>
  <Header title={`${frontmatter.title} | Erland`} canonical={canonical} jsonLd={jsonLd} />
  <body>
    <div class="content">
      <Sidebar selectedItem="blog" />
      <main class="main">
        <div class="container">
          <div class="back-nav-container">
            <a href="/blog" class="back-nav-button w-inline-block">
              <Icon name="back" class="back-nav-img" />
              <div>Back to blog</div>
            </a>
          </div>

          <article class="content-container" style="max-width: 780px;">
            <header style="margin-bottom:1rem;">
              {hero && (
                <img src={hero} alt={heroAlt} loading="eager" class="post-hero" />
              )}
              <h1 style="margin:0 0 .25rem 0;">{frontmatter.title}</h1>
              {frontmatter.publishDate && (
                <time datetime={new Date(frontmatter.publishDate).toISOString()} style="opacity:.7;">
                  {new Date(frontmatter.publishDate).toLocaleDateString('id-ID', { dateStyle: 'medium' })}
                </time>
              )}
              {frontmatter.tags?.length > 0 && (
                <ul style="display:flex; gap:.5rem; margin:.75rem 0 0; padding:0; list-style:none;">
                  {frontmatter.tags.map((t) => (
                    <li
                      style="
                        padding:.2rem .6rem;
                        border:1px solid var(--border, rgba(0,0,0,.08));
                        border-radius:999px;
                        font-size:.8rem;
                        opacity:.9;
                      "
                    >
                      {t}
                    </li>
                  ))}
                </ul>
              )}
            </header>

            <div class="prose">
              <Content />
            </div>
          </article>
        </div>
        <Footer />
      </main>
    </div>
    <!--[if lte IE 9]><script src="//cdnjs.cloudflare.com/ajax/libs/placeholders/3.0.2/placeholders.min.js"></script><![endif]-->
  </body>
  <style>
    .prose :is(p, ul, ol) { line-height: 1.75; }
    .prose pre { padding: 1rem; border-radius: 10px; overflow: auto; border:1px solid #252525; background:#0f1115; }
    .prose h1 { font-size: 2rem; line-height:1.25; margin:1.25rem 0 .5rem; letter-spacing:-.02em; }
    .prose h2 { font-size: 1.5rem; line-height:1.3; margin:1.2rem 0 .5rem; }
    .prose h3 { font-size: 1.25rem; line-height:1.35; margin:1rem 0 .4rem; }
    .prose img { border-radius: 12px; }
    .post-hero { display:block; width:100%; height:auto; border-radius:12px; margin:0 0 1rem 0; }
    @media (max-width: 640px) { .post-hero { border-radius: 12px; } }
  </style>
</html>
