---
import Header from '../../components/Header.astro';
import Sidebar from '../../components/Sidebar.astro';

export async function getStaticPaths() {
  const modules = import.meta.glob('../../posts/blog/*/index.md');
  const slugs = Object.keys(modules).map((p) => {
    const parts = p.split('/');
    return parts[parts.length - 2];
  });
  return slugs.map((slug) => ({ params: { slug } }));
}

const { slug } = Astro.params;
const modules = import.meta.glob('../../posts/blog/*/index.md');
const key = `../../posts/blog/${slug}/index.md`;
const loader = modules[key] as any;
const mod = loader ? await loader() : null;

if (!mod) {
  return Astro.redirect('/blog');
}

const { default: Content, frontmatter } = mod;

// Auto-detect hero image placed as: src/posts/blog/[slug]/hero.(jpg|jpeg|png|webp|gif|svg)
const heroMap = import.meta.glob('../../posts/blog/*/hero.{jpg,jpeg,png,webp,gif,svg}', {
  as: 'url',
  eager: true,
});
const hero = Object.entries(heroMap).find(([p]) => p.startsWith(`../../posts/blog/${slug}/hero.`))?.[1] as
  | string
  | undefined;
const heroAlt = frontmatter.heroAlt ?? frontmatter.title;
---

<!DOCTYPE html>
<html>
  <Header title={`${frontmatter.title} | Erland`} />
  <body>
    <div class="content">
      <Sidebar selectedItem="blog" />
      <main class="main">
        <div class="container">
          <div class="back-nav-container">
            <a href="/blog" class="back-nav-button w-inline-block">
              <img src="/assets/back.svg" loading="lazy" alt="" class="back-nav-img" />
              <div>Back to blog</div>
            </a>
          </div>

          <article class="content-container" style="max-width: 780px;">
            <header style="margin-bottom:1rem;">
              {hero && (
                <img
                  src={hero}
                  alt={heroAlt}
                  width="1440"
                  height="720"
                  loading="eager"
                  style="display:block; width:100%; height:auto; border-radius:12px; margin:0 0 1rem 0;"
                />
              )}
              <h1 style="margin:0 0 .25rem 0;">{frontmatter.title}</h1>
              {frontmatter.publishDate && (
                <time datetime={new Date(frontmatter.publishDate).toISOString()} style="opacity:.7;">
                  {new Date(frontmatter.publishDate).toLocaleDateString('id-ID', { dateStyle: 'medium' })}
                </time>
              )}
              {frontmatter.tags?.length > 0 && (
                <ul style="display:flex; gap:.5rem; margin:.75rem 0 0; padding:0; list-style:none;">
                  {frontmatter.tags.map((t) => (
                    <li
                      style="
                        padding:.2rem .6rem;
                        border:1px solid var(--border, rgba(0,0,0,.08));
                        border-radius:999px;
                        font-size:.8rem;
                        opacity:.9;
                      "
                    >
                      {t}
                    </li>
                  ))}
                </ul>
              )}
            </header>

            <div class="prose">
              <Content />
            </div>
          </article>
        </div>
      </main>
    </div>

    <!--[if lte IE 9]><script src="//cdnjs.cloudflare.com/ajax/libs/placeholders/3.0.2/placeholders.min.js"></script><![endif]-->
  </body>
  <style>
    .prose :is(p, ul, ol) { line-height: 1.75; }
    .prose pre { padding: 1rem; border-radius: 8px; overflow: auto; }
  </style>
</html>
