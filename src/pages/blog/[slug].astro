---
import SiteLayout from '@layouts/SiteLayout.astro';
import Icon from '@components/Icon.astro';
import BackNav from '@components/BackNav/BackNav.astro';
import { getCollection } from 'astro:content';
import { blogPostingJsonLd } from '@lib/content/seo';
import ShareButtons from '@components/ShareButtons/ShareButtons.astro';
import { SITE_URL } from '@lib/core/env';
import { SITE_CONFIG } from '@lib/core/site-config';
import blogStyles from './styles/_blog.module.css';
import '@/styles/components/article-detail.css';
import '@/styles/components/toc.css';
import '@/styles/prose/tables.css';
import '@/styles/prose/ads.css';
import ScrollTopButton from '@components/ScrollTopButton/ScrollTopButton.astro';
import ContentImage from '@components/ContentImage.astro';
import HeroImage from '@components/HeroImage.astro';
import { getOgImageUrl, resolveHero } from '@lib/content/images';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  return posts.map((p: any) => ({ params: { slug: p.slug } }));
}

const { slug } = Astro.params;
const entry = (await getCollection('blog')).find((e: any) => e.slug === slug);
if (!entry) {
  return Astro.redirect('/blog/');
}

const { Content } = await entry.render();
const frontmatter = entry.data;

const hero = resolveHero(frontmatter.hero);
const heroAlt = frontmatter.heroAlt ?? frontmatter.title;
const optimizedHero = hero ? await getOgImageUrl(hero, 1200, 'avif') : undefined;
const canonical = `/blog/${slug}/`;
const canonicalUrl = `${SITE_URL}${canonical}`;

const jsonLd = blogPostingJsonLd({
  title: frontmatter.title,
  canonical,
  publishDate: frontmatter.publishDate,
  updatedDate: frontmatter.updatedDate,
  image: optimizedHero ? [optimizedHero] : undefined,
  description: frontmatter.description,
  excerpt: frontmatter.excerpt,
  tags: frontmatter.tags,
  category: frontmatter.category,
});
---

<SiteLayout
  title={frontmatter.title}
  canonical={canonical}
  jsonLd={jsonLd}
  selectedItem="blog"
  description={frontmatter.description || frontmatter.excerpt}
  image={optimizedHero}
  type="article"
  publishedTime={frontmatter.publishDate}
  modifiedTime={frontmatter.updatedDate}
  tags={frontmatter.tags}
  author={SITE_CONFIG.author.name}
>
  <!-- Back Navigation - Return to blog listing page -->
  <BackNav href="/blog/" label="Back to Blog" />
  
  <!-- Blog Post Article - Full post content with SEO markup -->
  <article class:list={["content-container", "article-detail"]}>
    <!-- Article Header - Hero image, title, and metadata -->
    <header class="article-header">
      {/* Conditional: Hero image (optimized for LCP, eager loaded) */}
      {hero && (
        <HeroImage image={hero} alt={heroAlt} loading="eager" fetchpriority="high" />
      )}
      
      <!-- Article Title -->
      <h1 style="margin:0 0 .25rem 0;">{frontmatter.title}</h1>
      
      {/* Conditional: Article metadata (category and/or publish date) */}
      {(frontmatter.category || frontmatter.publishDate) && (
        <div class={blogStyles['blog-post__meta']}>
          {frontmatter.category && (
            <div class={blogStyles['blog-post__meta-item']}>
              <Icon name="blogTags" class={blogStyles['blog-post__meta-icon']} />
              <a href={`/blog/category/${(await import('@lib/content/blog')).slugifyCategory(String(frontmatter.category))}/`} class={blogStyles['blog-post__meta-text']}>{frontmatter.category}</a>
            </div>
          )}
          {frontmatter.publishDate && (
            <div class={blogStyles['blog-post__meta-item']}>
              <Icon name="blogDate" class={blogStyles['blog-post__meta-icon']} />
              <time datetime={new Date(frontmatter.publishDate).toISOString()} class={blogStyles['blog-post__meta-text']}>
                {new Date(frontmatter.publishDate).toLocaleDateString('id-ID', { dateStyle: 'medium' })}
              </time>
            </div>
          )}
        </div>
      )}
    </header>
    
    <!-- Article Content - Markdown rendered with custom image component -->
    <div class="prose" id="blog-content">
      <Content components={{ img: ContentImage }} />
    </div>
    
    <!-- Social Share Buttons - Share post to social platforms -->
    <ShareButtons title={frontmatter.title} url={canonicalUrl} description={frontmatter.description || frontmatter.excerpt} />
  </article>
  
  <!-- Scroll to Top Button - Floating button for long articles -->
  <ScrollTopButton />
  
  
</SiteLayout>

<script>
  import { autoInitBlogAds, autoInitBlogPlaceholders, shouldRenderAds, shouldRenderPlaceholders } from '@lib/tracking/ads';
  import { autoInit as autoInitToc } from '@lib/features/toc';
  // Initialize dynamic TOC after content renders
  const runToc = () => {
    try {
      autoInitToc();
    } catch {}
  };
  const runAds = () => {
    try {
      const client = import.meta.env.PUBLIC_ADSENSE_CLIENT || '';
      const slotStart = import.meta.env.PUBLIC_ADSENSE_SLOT_START || '';
      const slotEnd = import.meta.env.PUBLIC_ADSENSE_SLOT_END || '';
      
      if (
        shouldRenderAds({
          client,
          slots: [slotStart, slotEnd],
        })
      ) {
        autoInitBlogAds(client, slotStart, slotEnd);
      } else if (shouldRenderPlaceholders()) {
        autoInitBlogPlaceholders();
      }
    } catch {}
  };

  runToc();
  runAds();

  const rebroadcast = () => {
    runToc();
    runAds();
  };

  document.addEventListener('astro:page-load', rebroadcast);
  document.addEventListener('astro:after-swap', rebroadcast);
</script>
