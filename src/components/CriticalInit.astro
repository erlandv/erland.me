---
/**
 * CriticalInit Component
 *
 * Critical inline script that prevents FOUC (Flash of Unstyled Content) by initializing
 * theme and sidebar state before CSS loads.
 *
 * Initializes:
 * 1. Theme preference from localStorage ("light" | "dark" | "auto")
 * 2. Resolved theme based on system preference (when auto)
 * 3. Sidebar collapsed state on desktop (min-width: 1025px)
 * 4. CSS custom properties for transition prevention during initial load
 *
 * IMPORTANT:
 * - Must execute inline before CSS loads
 * - Do NOT move to external file or defer
 * - Minified for performance
 *
 * Sets on document.documentElement:
 * - data-theme: "light" (or removed for dark)
 * - data-theme-preference: user's preference ("light" | "dark" | "auto")
 * - data-theme-resolved: actual applied theme ("light" | "dark")
 * - data-sidebar: "collapsed" | "expanded" (desktop only)
 * - --sidebar-init-transition: "none" (prevents animated FOUC, removed by SidebarController)
 * - .sidebar-collapsed-global class (when sidebar collapsed)
 *
 * @component
 * @example
 * <CriticalInit />
 *
 * @note Should be placed in <head> via Header component before any CSS loads
 */
---

<!-- Critical inline script for theme initialization (runs before page render) -->
<script is:inline>
  (function () {
    try {
      // Get user's theme preference from localStorage
      let storedTheme = localStorage.getItem('theme-preference');
      const mediaQuery = window.matchMedia
        ? window.matchMedia('(prefers-color-scheme: dark)')
        : null;

      // Validate stored theme or default to "dark"
      storedTheme =
        storedTheme === 'light' ||
        storedTheme === 'dark' ||
        storedTheme === 'auto'
          ? storedTheme
          : 'dark';

      // Resolve actual theme based on preference
      let resolvedTheme;
      if (storedTheme === 'auto') {
        resolvedTheme = mediaQuery && mediaQuery.matches ? 'dark' : 'light';
      } else {
        resolvedTheme = storedTheme;
      }

      const root = document.documentElement;
      if (root) {
        // Set theme attributes
        if (resolvedTheme === 'light') {
          root.setAttribute('data-theme', 'light');
        } else {
          root.removeAttribute('data-theme');
        }
        root.setAttribute('data-theme-preference', storedTheme);
        root.setAttribute('data-theme-resolved', resolvedTheme);
      }

      // Initialize sidebar state on desktop
      const desktopMedia = window.matchMedia('(min-width: 1025px)');
      if (desktopMedia.matches) {
        const sidebarCollapsed =
          localStorage.getItem('sidebar-collapsed') === 'true';
        if (sidebarCollapsed) {
          root.classList.add('sidebar-collapsed-global');
          root.setAttribute('data-sidebar', 'collapsed');
          root.style.setProperty('--sidebar-init-transition', 'none');
        }
      }
    } catch (_err) {
      // Silently fail to prevent script errors
    }
  })();
</script>
