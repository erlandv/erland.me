---
/**
 * SidebarToggleButton Component
 *
 * Edge-mounted button to toggle sidebar between collapsed and expanded states.
 * Displays chevron icons that flip based on sidebar state.
 *
 * Features:
 * - Visual indicator of sidebar collapse state
 * - Animated icon transitions
 * - Syncs with sidebar state managed by SidebarController
 * - Desktop-only (hidden on mobile breakpoints)
 *
 * State synchronized via:
 * - data-sidebar attribute on document root
 * - MutationObserver for real-time state updates
 * - Checkbox input #sidebar-toggle
 *
 * @component
 * @example
 * <SidebarToggleButton />
 */
import Icon from '@components/Icon.astro';
import styles from './SidebarToggleButton.module.css';
---

<div class:list={[styles.wrapper, 'sidebar-edge-toggle-wrapper']}>
  <div class={styles.divider} aria-hidden='true'></div>
  <label
    id='sidebar-toggle-label'
    for='sidebar-toggle'
    title='sidebar'
    class:list={[styles.toggle, 'sidebar-toggle-button', 'sidebar-edge-toggle']}
    aria-label='Toggle sidebar width'
    tabindex='0'
  >
    <div class={styles.iconWrapper}>
      <Icon
        name='sidebarToggleLeft'
        class:list={[styles.icon, styles.iconLeft]}
      />
      <Icon
        name='sidebarToggleRight'
        class:list={[styles.icon, styles.iconRight]}
      />
    </div>
  </label>
</div>

<script>
  const WRAPPER_SELECTOR = '.sidebar-edge-toggle-wrapper';
  const TOGGLE_SELECTOR = '.sidebar-edge-toggle';
  const HTML_ATTR = 'data-sidebar';

  const LABEL_ID = 'sidebar-toggle-label';
  const updateState = () => {
    try {
      const wrapper = document.querySelector(WRAPPER_SELECTOR);
      const toggle = document.querySelector(TOGGLE_SELECTOR);
      if (!wrapper || !toggle) return;
      const sidebarToggle = document.getElementById('sidebar-toggle');
      const attrValue = document.documentElement.getAttribute(HTML_ATTR);
      let collapsed = attrValue === 'collapsed';
      if (!collapsed && sidebarToggle instanceof HTMLInputElement) {
        collapsed = sidebarToggle.checked;
      }
      wrapper.setAttribute('data-collapsed', collapsed ? 'true' : 'false');
      toggle.classList.toggle('is-active', collapsed);
      // Update dynamic title
      const label = document.getElementById(LABEL_ID);
      if (label) {
        label.title = collapsed ? 'expand sidebar' : 'collapse sidebar';
      }
    } catch {}
  };

  const init = () => {
    try {
      updateState();
      const observer = new MutationObserver(updateState);
      observer.observe(document.documentElement, {
        attributes: true,
        attributeFilter: [HTML_ATTR],
      });
      const sidebarToggle = document.getElementById('sidebar-toggle');
      if (sidebarToggle instanceof HTMLInputElement) {
        sidebarToggle.addEventListener('change', updateState);
      }
      document.addEventListener('astro:after-swap', updateState);
      document.addEventListener('astro:page-load', updateState);
    } catch {}
  };

  if (typeof window !== 'undefined') {
    if (
      document.readyState === 'complete' ||
      document.readyState === 'interactive'
    ) {
      init();
    } else {
      document.addEventListener('DOMContentLoaded', init, { once: true });
    }
  }
</script>
