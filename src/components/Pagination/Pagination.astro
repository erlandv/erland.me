---
/**
 * Pagination Component
 * 
 * Renders pagination controls with prev/next buttons and page numbers.
 * Implements responsive design: shows window of 4 page numbers on desktop/tablet,
 * reduces to 2 page numbers on mobile. Uses ellipsis for truncated ranges.
 * 
 * @component
 * @example
 * <Pagination 
 *   page={2}
 *   totalPages={10}
 *   pageHref={(n) => `/blog/page/${n}/`}
 * />
 * 
 * @param {Object} props
 * @param {number} props.page - Current page number (1-indexed)
 * @param {number} props.totalPages - Total number of pages
 * @param {Function} props.pageHref - Function that takes page number and returns URL string
 */
import styles from './pagination.module.css';
import Icon from '@components/Icon.astro';

interface Props {
  page: number;
  totalPages: number;
  pageHref: (n: number) => string;
}

const { page, totalPages, pageHref } = Astro.props as Props;

function clamp(n: number, min: number, max: number) {
  return Math.max(min, Math.min(n, max));
}

function getPageWindow(current: number, total: number, size: number): number[] {
  const half = Math.floor(size / 2);
  let start = clamp(current - half, 1, Math.max(1, total - size + 1));
  let end = Math.min(total, start + size - 1);
  start = Math.max(1, end - size + 1);
  return Array.from({ length: end - start + 1 }, (_, i) => start + i);
}

// Desktop/Tablet: window of 4 page numbers
const windowPages = getPageWindow(page, totalPages, 4);
const showLeadingEllipsis = windowPages[0] > 2;
const showTrailingEllipsis =
  windowPages[windowPages.length - 1] < totalPages - 1;

// Determine which window items to hide on mobile to show max 2 numbers
const mobileHideIdx = (() => {
  const len = windowPages.length;
  const currentIdx = windowPages.indexOf(page);
  if (len <= 2) return new Set<number>();
  if (len === 3) {
    // Keep 2 numbers: prefer current + next when in middle; otherwise current + neighbor
    if (currentIdx === 1) return new Set<number>([0]); // hide first, keep [current, next]
    if (currentIdx === 0) return new Set<number>([2]); // hide last, keep [current, next]
    return new Set<number>([0]); // currentIdx === 2 -> hide first, keep [prev, current]
  }
  if (len === 4) {
    // Keep 2 numbers based on where current is
    if (currentIdx <= 1) return new Set<number>([2, 3]); // near start: keep [0,1]
    return new Set<number>([0, 1]); // near end: keep [2,3]
  }
  // Fallback: hide edges to keep 2 centered
  return new Set<number>([0, len - 1]);
})();
---

<!-- Pagination Navigation - Responsive page number controls with prev/next buttons -->
<nav aria-label='Pagination' class={styles.pagination}>
  <!-- Previous Page Button - Disabled on first page -->
  <a
    href={pageHref(clamp(page - 1, 1, totalPages))}
    aria-label='Previous page'
    aria-disabled={page === 1 ? 'true' : undefined}
    tabindex={page === 1 ? -1 : undefined}
    class:list={[
      styles['page-link'],
      styles.icon,
      page === 1 && styles.disabled,
    ]}
  >
    <Icon name='arrowLeft' class={styles.iconSvg} />
  </a>

  {/* First Page Link - Always shown if current window doesn't start at page 1 */}
  {
    windowPages[0] > 1 && (
      <a href={pageHref(1)} class={styles['page-link']}>
        1
      </a>
    )
  }
  
  {/* Leading Ellipsis - Indicates skipped pages between first page and window */}
  {
    showLeadingEllipsis && (
      <span class={styles.ellipsis} aria-hidden='true'>
        …
      </span>
    )
  }

  {/* Page Number Window - Shows 4 page numbers on desktop, 2 on mobile */}
  {
    windowPages.map((n, idx) => {
      const active = n === page;
      return (
        <a
          href={pageHref(n)}
          aria-current={active ? 'page' : undefined}
          class:list={[
            styles['page-link'],
            active && styles.active,
            mobileHideIdx.has(idx) && styles.mobileHide,
          ]}
        >
          {n}
        </a>
      );
    })
  }

  {/* Trailing Ellipsis - Indicates skipped pages between window and last page */}
  {
    showTrailingEllipsis && (
      <span class={styles.ellipsis} aria-hidden='true'>
        …
      </span>
    )
  }
  
  {/* Last Page Link - Always shown if current window doesn't reach last page */}
  {
    windowPages[windowPages.length - 1] < totalPages && (
      <a href={pageHref(totalPages)} class={styles['page-link']}>
        {totalPages}
      </a>
    )
  }

  <!-- Next Page Button - Disabled on last page -->
  <a
    href={pageHref(clamp(page + 1, 1, totalPages))}
    aria-label='Next page'
    aria-disabled={page === totalPages ? 'true' : undefined}
    tabindex={page === totalPages ? -1 : undefined}
    class:list={[
      styles['page-link'],
      styles.icon,
      page === totalPages && styles.disabled,
    ]}
  >
    <Icon name='arrowRight' class={styles.iconSvg} />
  </a>
</nav>
