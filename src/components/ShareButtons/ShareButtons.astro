---
/**
 * ShareButtons Component
 * 
 * Social sharing buttons with native Web Share API support (falls back to platform-specific share URLs).
 * Displays share buttons for WhatsApp, Telegram, Twitter/X, Facebook, and LinkedIn.
 * On supported devices, shows native share and copy link buttons.
 * 
 * Features:
 * - Native Web Share API integration
 * - UTM parameters for tracking share sources
 * - Copy to clipboard functionality
 * - Graceful fallback to platform share URLs
 * - Client-side progressive enhancement
 * - Centralized platform configuration
 * 
 * @component
 * @example
 * <ShareButtons 
 *   title="My Blog Post"
 *   url="https://example.com/blog/post/"
 *   description="Post description for social sharing"
 *   heading="Share this article:"
 * />
 * 
 * @param {Object} props
 * @param {string} props.title - Title to share (used in share text and meta)
 * @param {string} props.url - Absolute URL to share (must be fully qualified)
 * @param {string} [props.description] - Description for sharing (optional, falls back to title)
 * @param {string} [props.heading="Share this article:"] - Section heading text
 */
import Icon from '@components/Icon.astro';
import styles from './share-buttons.module.css';
import { sharePlatforms } from '@lib/content/share-platforms';
import { addUTMParams, UTM_PRESETS } from '@lib/tracking/utm';

interface Props {
  title: string;
  url: string; // absolute URL
  description?: string;
  heading?: string;
}

const {
  title,
  url,
  description,
  heading = 'Share this article:',
}: Props = Astro.props as Props;

// Generate tracked URLs for each platform
const trackedUrls = sharePlatforms.reduce(
  (acc, platform) => {
    acc[platform.id] = addUTMParams(url, {
      source: platform.id,
      ...UTM_PRESETS.shareButton,
    });
    return acc;
  },
  {} as Record<string, string>
);

// Special URLs for copy and webshare
const shareUrlCopy = addUTMParams(url, { source: 'copy', ...UTM_PRESETS.shareButton });
const shareUrlWebShare = addUTMParams(url, { source: 'webshare', ...UTM_PRESETS.shareButton });

// Build platform share URLs with UTM tracking
const platformShareUrls = sharePlatforms.map(platform => ({
  platform,
  href: platform.buildUrl({
    url: trackedUrls[platform.id],
    title,
    text: description || title,
  }),
}));
---

<!-- Social Share Section - Native Web Share API + fallback platform-specific buttons -->
<section
  class='share'
  data-title={title}
  data-text={description || title}
  data-url={shareUrlWebShare}
>
  <h3 class={styles['share__title']}>{heading}</h3>

  <!-- Share Buttons Container - Progressive enhancement based on device capabilities -->
  <div class={styles['share__wrap']}>
    <!-- Native Share Options - Shown only on devices with Web Share API support (hidden by default, revealed by JS) -->
    <div class:list={[styles['share__native'], 'share__native']} hidden>
      <!-- Native Share Button - Opens system share sheet -->
      <button
        class:list={[styles['share__btn'], 'share__btn--native']}
        type='button'
        aria-label='Share via native share'
      >
        <Icon name='blogShare' class={styles['share__icon']} ariaLabel='Share' />
      </button>
      
      <!-- Copy Link Button - Copies URL to clipboard -->
      <button
        class:list={[styles['share__btn'], 'share__btn--copy']}
        type='button'
        aria-label='Copy link'
        data-copy={shareUrlCopy}
      >
        <Icon name='btnCopy' class={styles['share__icon']} ariaLabel='Copy link' />
      </button>
    </div>

    <!-- Fallback Share Buttons - Platform-specific share links (always visible) -->
    <div class={styles['share__fallback']}>
      {platformShareUrls.map(({ platform, href }) => (
        <a
          class={styles['share__btn']}
          href={href}
          target='_blank'
          rel='nofollow noopener noreferrer'
          aria-label={platform.ariaLabel}
        >
          <Icon
            name={platform.icon}
            class={styles['share__icon']}
            ariaLabel={platform.name}
          />
        </a>
      ))}
    </div>
  </div>
</section>
